<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechManager: Maintenance System v4.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#475569',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">

    <nav class="bg-white border-b border-slate-200 sticky top-0 z-40 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-screwdriver-wrench text-primary text-2xl"></i>
                    <span class="font-bold text-xl tracking-tight text-slate-800">TechManager <span class="text-xs bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full">v4.0</span></span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="app.syncData()" id="btn-sync" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                        <i class="fa-solid fa-rotate"></i> Sync
                    </button>
                    <button onclick="ui.showSettings()" class="text-slate-400 hover:text-slate-600 p-2">
                        <i class="fa-solid fa-gear text-lg"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                <div class="text-xs text-slate-500 uppercase font-bold tracking-wider mb-1">Total Aset</div>
                <div class="text-2xl font-bold text-slate-800" id="stat-total">0</div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 border-l-4 border-l-success">
                <div class="text-xs text-slate-500 uppercase font-bold tracking-wider mb-1">Kondisi Normal</div>
                <div class="text-2xl font-bold text-success" id="stat-normal">0</div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 border-l-4 border-l-danger">
                <div class="text-xs text-slate-500 uppercase font-bold tracking-wider mb-1">Masalah / Rusak</div>
                <div class="text-2xl font-bold text-danger" id="stat-issue">0</div>
            </div>
             <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                <div class="text-xs text-slate-500 uppercase font-bold tracking-wider mb-1">Analisa Cepat</div>
                <button onclick="ui.showAnalyticsModal()" class="w-full py-1 bg-indigo-50 text-indigo-600 hover:bg-indigo-100 rounded text-sm font-bold transition mt-1">
                    <i class="fa-solid fa-chart-pie mr-2"></i> Buka Detail
                </button>
            </div>
        </div>

        <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
            <div class="relative w-full md:w-96">
                <i class="fa-solid fa-search absolute left-3 top-3 text-slate-400"></i>
                <input type="text" id="search-input" placeholder="Cari aset, lokasi, atau serial..." class="w-full pl-10 pr-4 py-2.5 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-primary/20 transition shadow-sm">
            </div>
            <div class="flex gap-2 w-full md:w-auto">
                <button onclick="ui.toggleMultiSelect()" id="btn-multiselect" class="flex-1 md:flex-none px-4 py-2.5 border border-slate-200 rounded-lg text-slate-600 hover:bg-slate-50 font-medium text-sm transition">
                    <i class="fa-solid fa-list-check mr-2"></i> Pilih
                </button>
                
                <button onclick="ui.showExportMenu()" class="flex-1 md:flex-none px-4 py-2.5 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-medium transition shadow-sm flex items-center justify-center gap-2">
                    <i class="fa-solid fa-file-export"></i> Export Laporan
                </button>

                <button onclick="ui.openModal()" class="flex-1 md:flex-none px-6 py-2.5 bg-primary hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition shadow-md shadow-blue-500/30">
                    <i class="fa-solid fa-plus mr-2"></i> Baru
                </button>
            </div>
        </div>

        <div class="flex gap-2 mb-6 overflow-x-auto pb-2" id="filter-container">
            <button onclick="app.filterBy('all')" class="filter-btn active whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-medium bg-slate-200 text-slate-700 transition">Semua</button>
            <button onclick="app.filterBy('AC')" class="filter-btn whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-medium text-slate-500 hover:bg-slate-100 transition">AC</button>
            <button onclick="app.filterBy('Light')" class="filter-btn whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-medium text-slate-500 hover:bg-slate-100 transition">Lampu</button>
            <button onclick="app.filterBy('Other')" class="filter-btn whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-medium text-slate-500 hover:bg-slate-100 transition">Lainnya</button>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 border-b border-slate-200 text-slate-500 uppercase text-xs tracking-wider">
                        <tr>
                            <th class="px-6 py-4 font-semibold w-12 text-center"><i class="fa-solid fa-check-double"></i></th>
                            <th class="px-6 py-4 font-semibold">Aset / Brand</th>
                            <th class="px-6 py-4 font-semibold">Lokasi</th>
                            <th class="px-6 py-4 font-semibold">Kategori</th>
                            <th class="px-6 py-4 font-semibold">Status</th>
                            <th class="px-6 py-4 font-semibold text-right">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="asset-list" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
            <div id="empty-state" class="hidden p-12 text-center">
                <div class="bg-slate-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-box-open text-slate-300 text-2xl"></i>
                </div>
                <h3 class="text-slate-800 font-medium mb-1">Data tidak ditemukan</h3>
                <p class="text-slate-500 text-sm">Coba ubah kata kunci atau filter pencarian.</p>
            </div>
        </div>
    </main>

    <div id="bulk-actions" class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-4 shadow-lg transform translate-y-full transition-transform duration-300 z-30">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <span class="font-medium text-slate-700"><span id="selected-count">0</span> aset terpilih</span>
            <div class="flex gap-2">
                <button onclick="app.bulkDelete()" class="px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 font-medium text-sm">Hapus</button>
                <button onclick="ui.toggleMultiSelect()" class="px-4 py-2 bg-slate-100 text-slate-600 rounded-lg font-medium text-sm">Batal</button>
            </div>
        </div>
    </div>

    <div id="modal-form" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm transition-opacity p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden transform transition-all scale-100">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-lg text-slate-800" id="modal-title">Edit Aset</h3>
                <button onclick="ui.closeModal('modal-form')" class="text-slate-400 hover:text-slate-600 transition"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="field-id">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1.5">Kategori</label>
                        <select id="field-category" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary/20 outline-none text-sm bg-white">
                            <option value="AC">AC (Pendingin)</option>
                            <option value="Light">Lampu / Penerangan</option>
                            <option value="Electronics">Elektronik Lain</option>
                            <option value="Furniture">Furniture</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1.5">Kondisi</label>
                        <select id="field-condition" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary/20 outline-none text-sm bg-white" onchange="ui.toggleIssueField(this.value)">
                            <option value="Normal">Normal / Baik</option>
                            <option value="Rusak">Rusak</option>
                            <option value="Perbaikan">Butuh Perbaikan</option>
                            <option value="Disposal">Afkir / Buang</option>
                        </select>
                    </div>
                </div>

                <div id="field-issue-container" class="hidden bg-red-50 p-3 rounded-lg border border-red-100 animate-fade-in">
                    <label class="block text-xs font-semibold text-red-500 uppercase mb-1.5">Deskripsi Masalah</label>
                    <input type="text" id="field-issue" class="w-full px-3 py-2 border border-red-200 rounded-lg focus:ring-2 focus:ring-red-200 outline-none text-sm text-red-700 placeholder-red-300" placeholder="Contoh: Modul mati, Freon bocor">
                </div>

                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1.5">Lokasi</label>
                    <input type="text" id="field-location" list="list-locations" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary/20 outline-none text-sm" placeholder="Ketik atau pilih lokasi...">
                    <datalist id="list-locations"></datalist>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1.5">Merek (Brand)</label>
                        <input type="text" id="field-brand" list="list-brands" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary/20 outline-none text-sm" placeholder="Daikin, Philips...">
                        <datalist id="list-brands"></datalist>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1.5">Model / Tipe</label>
                        <input type="text" id="field-model" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary/20 outline-none text-sm" placeholder="PK, Watt...">
                    </div>
                </div>

                 <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1.5">Sub-Tipe</label>
                    <input type="text" id="field-subtype" list="list-subtypes" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary/20 outline-none text-sm" placeholder="Split Wall, Cassette, TL...">
                     <datalist id="list-subtypes"></datalist>
                </div>

            </div>
            <div class="bg-slate-50 px-6 py-4 flex justify-end gap-3">
                <button onclick="ui.closeModal('modal-form')" class="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-lg text-sm font-medium transition">Batal</button>
                <button onclick="app.saveAsset()" class="px-6 py-2 bg-primary hover:bg-blue-700 text-white rounded-lg text-sm font-medium shadow-md transition">Simpan</button>
            </div>
        </div>
    </div>

    <div id="modal-analytics" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl w-full max-w-4xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-indigo-50">
                <h3 class="font-bold text-lg text-indigo-900"><i class="fa-solid fa-chart-pie mr-2"></i>Analisa Detail Aset</h3>
                <button onclick="ui.closeModal('modal-analytics')" class="text-indigo-400 hover:text-indigo-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            
            <div class="p-4 border-b border-slate-100 bg-white flex gap-4 items-center">
                <span class="text-sm font-semibold text-slate-500">Filter:</span>
                <select id="analytics-cat" onchange="app.renderAnalytics()" class="border border-slate-300 rounded px-3 py-1 text-sm">
                    <option value="All">Semua Aset</option>
                    <option value="AC">AC (Pendingin)</option>
                    <option value="Light">Lampu</option>
                </select>
                <div class="text-xs text-slate-400 ml-auto">Data dikelompokkan: Lokasi > Merek > Kondisi</div>
            </div>

            <div class="overflow-y-auto p-0 flex-1">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 text-slate-500 uppercase text-xs sticky top-0 shadow-sm">
                        <tr>
                            <th class="px-6 py-3 font-semibold">Lokasi</th>
                            <th class="px-6 py-3 font-semibold">Merek</th>
                            <th class="px-6 py-3 text-center bg-slate-100">Total</th>
                            <th class="px-6 py-3 text-center text-green-600 bg-green-50">Normal</th>
                            <th class="px-6 py-3 text-center text-red-600 bg-red-50">Rusak</th>
                            <th class="px-6 py-3 text-center text-orange-600 bg-orange-50">Servis</th>
                        </tr>
                    </thead>
                    <tbody id="analytics-body" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
             <div class="p-4 bg-slate-50 border-t border-slate-200 text-right">
                <button onclick="ui.closeModal('modal-analytics')" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg text-sm font-medium">Tutup</button>
            </div>
        </div>
    </div>

    <div id="modal-settings" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800">Konfigurasi GitHub</h3>
                <button onclick="ui.closeModal('modal-settings')" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 mb-4">
                    <p class="text-xs text-blue-700"><i class="fa-solid fa-database mr-1"></i> Database: db_maintenance.json</p>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Username</label>
                    <input type="text" id="conf-owner" class="w-full px-3 py-2 border rounded-lg text-sm">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Repository</label>
                    <input type="text" id="conf-repo" class="w-full px-3 py-2 border rounded-lg text-sm">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Token (PAT)</label>
                    <input type="password" id="conf-token" class="w-full px-3 py-2 border rounded-lg text-sm">
                </div>
                <button onclick="app.saveConfig()" class="w-full py-2.5 bg-slate-800 hover:bg-slate-900 text-white rounded-lg text-sm font-medium mt-2">Simpan</button>
            </div>
        </div>
    </div>

    <script>
        // --- LOGIC ---
        const state = {
            config: JSON.parse(localStorage.getItem('techmanager_conf') || '{"owner":"","repo":"","token":""}'),
            data: { assets: [] },
            sha: null,
            ui: { 
                currentFilter: 'all', 
                multiSelectMode: false, 
                selectedIds: new Set(),
                brands: new Set(),
                locations: new Set(),
                subtypes: new Set()
            }
        };

        const api = {
            headers: () => ({
                'Authorization': `token ${state.config.token}`,
                'Accept': 'application/vnd.github.v3+json'
            }),
            url: () => `https://api.github.com/repos/${state.config.owner}/${state.config.repo}/contents/db_maintenance.json`,
            
            async fetch() {
                if(!state.config.token) return ui.showSettings();
                Swal.fire({title: 'Memuat data...', didOpen: () => Swal.showLoading(), allowOutsideClick: false});
                
                try {
                    const res = await fetch(api.url(), { headers: api.headers() });
                    if(!res.ok) throw new Error('Gagal koneksi ke GitHub');
                    const json = await res.json();
                    
                    state.sha = json.sha;
                    const content = decodeURIComponent(escape(atob(json.content)));
                    state.data = JSON.parse(content);
                    
                    app.analyzeData(); 
                    app.renderAssets();
                    Swal.close();
                } catch (e) {
                    Swal.fire('Error', e.message, 'error');
                }
            },

            async push() {
                Swal.fire({title: 'Menyimpan...', didOpen: () => Swal.showLoading(), allowOutsideClick: false});
                try {
                    const getRes = await fetch(api.url(), { headers: api.headers() });
                    if(getRes.ok) {
                        const getJson = await getRes.json();
                        state.sha = getJson.sha;
                    }

                    const content = btoa(unescape(encodeURIComponent(JSON.stringify(state.data, null, 2))));
                    const body = {
                        message: `Update via Web ${new Date().toLocaleString()}`,
                        content: content,
                        sha: state.sha
                    };

                    const res = await fetch(api.url(), {
                        method: 'PUT',
                        headers: api.headers(),
                        body: JSON.stringify(body)
                    });

                    if(!res.ok) throw new Error('Gagal simpan ke GitHub');
                    
                    const resJson = await res.json();
                    state.sha = resJson.content.sha;
                    Swal.fire({icon: 'success', title: 'Tersimpan!', timer: 1000, showConfirmButton: false});
                } catch (e) {
                    Swal.fire('Gagal', e.message, 'error');
                }
            }
        };

        const app = {
            init: () => {
                const searchInput = document.getElementById('search-input');
                searchInput.addEventListener('input', app.renderAssets);
                if(state.config.token) api.fetch();
                else ui.showSettings();
            },

            analyzeData: () => {
                state.ui.brands.clear();
                state.ui.locations.clear();
                state.ui.subtypes.clear();
                
                state.data.assets.forEach(a => {
                    if(a.brand) state.ui.brands.add(a.brand.trim());
                    if(a.location) state.ui.locations.add(a.location.trim());
                    if(a.subtype) state.ui.subtypes.add(a.subtype.trim());
                });

                ui.populateDatalist('list-brands', state.ui.brands);
                ui.populateDatalist('list-locations', state.ui.locations);
                ui.populateDatalist('list-subtypes', state.ui.subtypes);
            },

            renderAssets: () => {
                const list = document.getElementById('asset-list');
                const search = document.getElementById('search-input').value.toLowerCase();
                list.innerHTML = '';
                
                let filtered = state.data.assets.filter(item => {
                    const matchSearch = Object.values(item).some(val => String(val).toLowerCase().includes(search));
                    const matchCat = state.ui.currentFilter === 'all' || item.category === state.ui.currentFilter;
                    return matchSearch && matchCat;
                });

                // Stats Update
                const globalStats = state.data.assets;
                const countNormal = globalStats.filter(a => a.condition === 'Normal').length;
                const countIssue = globalStats.filter(a => a.condition !== 'Normal').length;

                document.getElementById('stat-total').innerText = globalStats.length;
                document.getElementById('stat-normal').innerText = countNormal;
                document.getElementById('stat-issue').innerText = countIssue;

                if (filtered.length === 0) {
                    document.getElementById('empty-state').classList.remove('hidden');
                    return;
                } else {
                    document.getElementById('empty-state').classList.add('hidden');
                }

                filtered.sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt));

                filtered.forEach(asset => {
                    const isSelected = state.ui.selectedIds.has(asset.id);
                    const isBroken = asset.condition !== 'Normal';
                    const rowClass = isBroken ? 'bg-red-50 hover:bg-red-100' : 'hover:bg-slate-50';
                    const statusColor = isBroken ? 'text-red-600 bg-red-100' : 'text-green-600 bg-green-100';

                    const row = document.createElement('tr');
                    row.className = `border-b border-slate-100 transition group ${rowClass}`;
                    row.innerHTML = `
                        <td class="px-6 py-4 text-center">
                            ${state.ui.multiSelectMode ? 
                                `<input type="checkbox" onchange="app.selectAsset('${asset.id}')" ${isSelected ? 'checked' : ''} class="w-4 h-4 rounded text-primary focus:ring-primary">` : 
                                `<div class="w-2 h-2 rounded-full ${isBroken ? 'bg-red-500' : 'bg-green-400'} mx-auto"></div>`
                            }
                        </td>
                        <td class="px-6 py-4">
                            <div class="font-bold text-slate-700">${asset.brand || '-'} <span class="font-normal text-slate-500">${asset.model || ''}</span></div>
                            <div class="text-xs text-slate-400">${asset.subtype || ''}</div>
                        </td>
                        <td class="px-6 py-4 text-slate-600">${asset.location}</td>
                        <td class="px-6 py-4">
                            <span class="px-2.5 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-600 border border-slate-200">${asset.category}</span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2.5 py-1 rounded-full text-xs font-bold ${statusColor}">
                                ${asset.condition}
                            </span>
                            ${asset.issue ? `<div class="text-xs text-red-500 mt-1"><i class="fa-solid fa-triangle-exclamation mr-1"></i>${asset.issue}</div>` : ''}
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="ui.editAsset('${asset.id}')" class="text-slate-400 hover:text-primary transition mr-2"><i class="fa-solid fa-pen-to-square"></i></button>
                            ${!state.ui.multiSelectMode ? `<button onclick="app.deleteAsset('${asset.id}')" class="text-slate-400 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button>` : ''}
                        </td>
                    `;
                    list.appendChild(row);
                });
            },

            renderAnalytics: () => {
                const cat = document.getElementById('analytics-cat').value;
                const tbody = document.getElementById('analytics-body');
                tbody.innerHTML = '';

                // 1. Group Data
                const groups = {};
                state.data.assets.forEach(a => {
                    if (cat !== 'All' && a.category !== cat) return;
                    
                    const loc = (a.location || 'Tanpa Lokasi').trim();
                    const brand = (a.brand || 'Tanpa Merek').trim();
                    
                    if (!groups[loc]) groups[loc] = {};
                    if (!groups[loc][brand]) groups[loc][brand] = { total:0, normal:0, rusak:0, servis:0 };

                    groups[loc][brand].total++;
                    if (a.condition === 'Normal') groups[loc][brand].normal++;
                    else if (a.condition === 'Rusak' || a.condition === 'Disposal') groups[loc][brand].rusak++;
                    else groups[loc][brand].servis++;
                });

                // 2. Render Table
                const locKeys = Object.keys(groups).sort();
                if (locKeys.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-slate-400">Tidak ada data untuk kategori ini.</td></tr>`;
                    return;
                }

                locKeys.forEach(loc => {
                    const brands = groups[loc];
                    Object.keys(brands).sort().forEach((brand, idx) => {
                        const data = brands[brand];
                        const tr = document.createElement('tr');
                        tr.className = "border-b border-slate-50 hover:bg-slate-50";
                        const locCell = idx === 0 ? `<td class="px-6 py-3 font-bold text-slate-700 bg-slate-50/50" rowspan="${Object.keys(brands).length}">${loc}</td>` : '';
                        
                        tr.innerHTML = `
                            ${locCell}
                            <td class="px-6 py-3 text-slate-600">${brand}</td>
                            <td class="px-6 py-3 text-center font-bold bg-slate-100">${data.total}</td>
                            <td class="px-6 py-3 text-center text-green-600 bg-green-50">${data.normal > 0 ? data.normal : '-'}</td>
                            <td class="px-6 py-3 text-center text-red-600 bg-red-50 font-bold">${data.rusak > 0 ? data.rusak : '-'}</td>
                            <td class="px-6 py-3 text-center text-orange-600 bg-orange-50">${data.servis > 0 ? data.servis : '-'}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                });
            },

            saveAsset: () => {
                const id = document.getElementById('field-id').value;
                const condition = document.getElementById('field-condition').value;
                const getVal = (eid) => document.getElementById(eid).value.trim();

                const asset = {
                    id: id || 'mkd' + Math.random().toString(36).substr(2, 16),
                    category: getVal('field-category'),
                    location: getVal('field-location'),
                    brand: getVal('field-brand'),
                    model: getVal('field-model'),
                    subtype: getVal('field-subtype'),
                    condition: condition,
                    issue: condition === 'Normal' ? '' : getVal('field-issue'),
                    updatedAt: new Date().toISOString()
                };

                if(!asset.location || !asset.brand) return Swal.fire('Error', 'Lokasi dan Merek wajib diisi', 'warning');

                if (id) {
                    const idx = state.data.assets.findIndex(a => a.id === id);
                    state.data.assets[idx] = { ...state.data.assets[idx], ...asset };
                } else {
                    state.data.assets.push(asset);
                }

                ui.closeModal('modal-form');
                app.analyzeData();
                app.renderAssets();
                api.push();
            },

            deleteAsset: (id) => {
                Swal.fire({
                    title: 'Hapus aset?', text: "Data tidak bisa dikembalikan!", icon: 'warning',
                    showCancelButton: true, confirmButtonColor: '#ef4444', confirmButtonText: 'Ya, Hapus'
                }).then((result) => {
                    if (result.isConfirmed) {
                        state.data.assets = state.data.assets.filter(a => a.id !== id);
                        app.renderAssets();
                        api.push();
                    }
                });
            },

            selectAsset: (id) => {
                if(state.ui.selectedIds.has(id)) state.ui.selectedIds.delete(id);
                else state.ui.selectedIds.add(id);
                ui.updateBulkBar();
                app.renderAssets();
            },
            
            bulkDelete: () => {
                if(state.ui.selectedIds.size === 0) return;
                Swal.fire({title: `Hapus ${state.ui.selectedIds.size} aset?`, icon:'warning', showCancelButton:true, confirmButtonColor:'#d33'})
                .then(res => {
                    if(res.isConfirmed) {
                        state.data.assets = state.data.assets.filter(a => !state.ui.selectedIds.has(a.id));
                        state.ui.selectedIds.clear();
                        ui.toggleMultiSelect();
                        api.push();
                    }
                });
            },

            filterBy: (cat) => {
                state.ui.currentFilter = cat;
                document.querySelectorAll('.filter-btn').forEach(b => {
                    b.classList.remove('bg-slate-800', 'text-white');
                    b.classList.add('bg-slate-200', 'text-slate-700');
                    if(b.innerText.includes(cat === 'all' ? 'Semua' : cat)) {
                        b.classList.remove('bg-slate-200', 'text-slate-700');
                        b.classList.add('bg-slate-800', 'text-white');
                    }
                });
                app.renderAssets();
            },

            saveConfig: () => {
                const conf = {
                    owner: document.getElementById('conf-owner').value.trim(),
                    repo: document.getElementById('conf-repo').value.trim(),
                    token: document.getElementById('conf-token').value.trim()
                };
                localStorage.setItem('techmanager_conf', JSON.stringify(conf));
                state.config = conf;
                ui.closeModal('modal-settings');
                api.fetch();
            },

            syncData: () => api.fetch(),

            // --- EXPORT FEATURES (IMPROVED) ---
            exportData: (type) => {
                const data = state.data.assets;
                if(data.length === 0) return Swal.fire('Data Kosong', 'Tidak ada aset untuk diexport', 'warning');
                const timestamp = new Date().toISOString().slice(0,10);

                if (type === 'excel') {
                    // Excel with proper headers
                    const rows = data.map(a => ({
                        "Kategori": a.category,
                        "Lokasi": a.location,
                        "Brand": a.brand,
                        "Model": a.model,
                        "Sub-Tipe": a.subtype,
                        "Kondisi": a.condition,
                        "Masalah": a.issue || '-',
                        "Terakhir Update": a.updatedAt.slice(0,10)
                    }));
                    const ws = XLSX.utils.json_to_sheet(rows);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Assets");
                    XLSX.writeFile(wb, `Laporan_Aset_${timestamp}.xlsx`);
                } 
                else if (type === 'pdf') {
                    // PDF Grouped by Location
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    doc.setFontSize(18);
                    doc.text("Laporan Aset & Maintenance", 14, 20);
                    doc.setFontSize(10);
                    doc.text(`Tanggal: ${timestamp} | Total Aset: ${data.length}`, 14, 28);
                    
                    // Grouping for nice PDF layout
                    const grouped = {};
                    data.forEach(a => {
                        if(!grouped[a.location]) grouped[a.location] = [];
                        grouped[a.location].push([a.category, a.brand + ' ' + (a.model||''), a.condition, a.issue || '-']);
                    });

                    let finalY = 35;
                    Object.keys(grouped).sort().forEach(loc => {
                        doc.setFontSize(12);
                        doc.setTextColor(40);
                        // Add Location Header
                        doc.text(`Lokasi: ${loc}`, 14, finalY + 10);
                        
                        doc.autoTable({
                            startY: finalY + 15,
                            head: [['Kategori', 'Aset', 'Kondisi', 'Masalah']],
                            body: grouped[loc],
                            theme: 'grid',
                            headStyles: { fillColor: [50, 50, 50] },
                            margin: { top: 10 }
                        });
                        finalY = doc.lastAutoTable.finalY + 5;
                    });

                    doc.save(`Laporan_Aset_${timestamp}.pdf`);
                } 
                else if (type === 'word') {
                    // HTML to Word (Cleanest method for tables)
                    let html = `
                        <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                        <head><meta charset='utf-8'><title>Laporan Aset</title>
                        <style>
                            body { font-family: Calibri, sans-serif; }
                            table { border-collapse: collapse; width: 100%; }
                            th, td { border: 1px solid #000; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; }
                            .rusak { color: red; font-weight: bold; }
                        </style>
                        </head><body>
                        <h2>Laporan Maintenance Aset</h2>
                        <p>Tanggal: ${timestamp}</p>
                        <table>
                            <thead>
                                <tr>
                                    <th>Lokasi</th>
                                    <th>Aset / Brand</th>
                                    <th>Kategori</th>
                                    <th>Kondisi</th>
                                    <th>Keterangan</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    // Sort by location
                    data.sort((a,b) => (a.location || '').localeCompare(b.location || ''));
                    
                    data.forEach(a => {
                        html += `
                            <tr>
                                <td>${a.location}</td>
                                <td>${a.brand} ${a.model || ''}</td>
                                <td>${a.category}</td>
                                <td class="${a.condition !== 'Normal' ? 'rusak' : ''}">${a.condition}</td>
                                <td>${a.issue || ''}</td>
                            </tr>
                        `;
                    });

                    html += `</tbody></table></body></html>`;
                    
                    const blob = new Blob([html], { type: 'application/msword' });
                    saveAs(blob, `Laporan_Aset_${timestamp}.doc`);
                }
            }
        };

        const ui = {
            openModal: () => {
                document.getElementById('modal-title').innerText = 'Tambah Aset';
                document.getElementById('field-id').value = '';
                document.querySelectorAll('input:not([type=hidden])').forEach(i => i.value = '');
                document.getElementById('field-condition').value = 'Normal';
                ui.toggleIssueField('Normal');
                document.getElementById('modal-form').classList.remove('hidden');
                document.getElementById('modal-form').classList.add('flex');
            },
            editAsset: (id) => {
                const asset = state.data.assets.find(a => a.id === id);
                if(!asset) return;
                document.getElementById('modal-title').innerText = 'Edit Aset';
                document.getElementById('field-id').value = asset.id;
                document.getElementById('field-category').value = asset.category;
                document.getElementById('field-location').value = asset.location;
                document.getElementById('field-brand').value = asset.brand;
                document.getElementById('field-model').value = asset.model;
                document.getElementById('field-subtype').value = asset.subtype;
                document.getElementById('field-condition').value = asset.condition;
                document.getElementById('field-issue').value = asset.issue;
                
                ui.toggleIssueField(asset.condition);
                document.getElementById('modal-form').classList.remove('hidden');
                document.getElementById('modal-form').classList.add('flex');
            },
            showAnalyticsModal: () => {
                app.renderAnalytics();
                document.getElementById('modal-analytics').classList.remove('hidden');
                document.getElementById('modal-analytics').classList.add('flex');
            },
            closeModal: (id) => {
                document.getElementById(id).classList.add('hidden');
                document.getElementById(id).classList.remove('flex');
            },
            toggleIssueField: (val) => {
                const div = document.getElementById('field-issue-container');
                if(val === 'Normal') div.classList.add('hidden');
                else div.classList.remove('hidden');
            },
            populateDatalist: (id, set) => {
                const dl = document.getElementById(id);
                dl.innerHTML = '';
                Array.from(set).sort().forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item;
                    dl.appendChild(opt);
                });
            },
            showSettings: () => {
                document.getElementById('conf-owner').value = state.config.owner;
                document.getElementById('conf-repo').value = state.config.repo;
                document.getElementById('conf-token').value = state.config.token;
                document.getElementById('modal-settings').classList.remove('hidden');
                document.getElementById('modal-settings').classList.add('flex');
            },
            toggleMultiSelect: () => {
                state.ui.multiSelectMode = !state.ui.multiSelectMode;
                state.ui.selectedIds.clear();
                const btn = document.getElementById('btn-multiselect');
                const bar = document.getElementById('bulk-actions');
                
                if(state.ui.multiSelectMode) {
                    btn.classList.add('bg-slate-800', 'text-white', 'border-transparent');
                    btn.classList.remove('bg-white', 'text-slate-600', 'border-slate-200');
                    bar.classList.remove('translate-y-full');
                } else {
                    btn.classList.remove('bg-slate-800', 'text-white', 'border-transparent');
                    btn.classList.add('bg-white', 'text-slate-600', 'border-slate-200');
                    bar.classList.add('translate-y-full');
                }
                app.renderAssets();
            },
            
            // NEW EXPORT UI
            showExportMenu: () => {
                Swal.fire({
                    title: 'Export Laporan',
                    html: `Pilih format laporan yang Anda butuhkan:<br>
                           <p class="text-xs text-slate-500 mt-2">Data akan disesuaikan dengan filter terbaru.</p>`,
                    showDenyButton: true,
                    showCancelButton: true,
                    confirmButtonText: '<i class="fa-solid fa-file-excel"></i> Excel',
                    denyButtonText: '<i class="fa-solid fa-file-pdf"></i> PDF',
                    cancelButtonText: '<i class="fa-solid fa-file-word"></i> Word',
                    confirmButtonColor: '#10b981', // Green for Excel
                    denyButtonColor: '#ef4444',    // Red for PDF
                    cancelButtonColor: '#2563eb'   // Blue for Word
                }).then((result) => {
                    if (result.isConfirmed) app.exportData('excel');
                    else if (result.isDenied) app.exportData('pdf');
                    else if (result.dismiss === Swal.DismissReason.cancel) app.exportData('word');
                });
            },
            
            updateBulkBar: () => document.getElementById('selected-count').innerText = state.ui.selectedIds.size
        };

        // Start
        document.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>
