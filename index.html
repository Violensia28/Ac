<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechManager: Maintenance System</title>
    
    <!-- LIBRARIES (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.7/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        tailwind.config = {
            theme: { extend: { colors: { primary: '#2563eb', secondary: '#475569' } } }
        }
    </script>
    <style>
        body { font-family: 'Segoe UI', Inter, sans-serif; background-color: #f1f5f9; }
        .asset-card { transition: all 0.2s; }
        .asset-card.selected { border: 2px solid #2563eb; background-color: #eff6ff; }
        @media print {
            @page { size: A3 landscape; margin: 10mm; }
            body { background: white; -webkit-print-color-adjust: exact; }
            nav, .no-print, .tab-nav { display: none !important; }
            #view-assets { display: block !important; }
            .asset-card { break-inside: avoid; border: 1px solid #ccc; box-shadow: none; page-break-inside: avoid; }
            #asset-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">
<!-- NAVBAR -->
    <nav class="bg-white border-b px-4 py-2 flex justify-between items-center shadow-sm z-20 no-print">
        <div class="flex items-center gap-3">
            <div class="bg-primary text-white p-2 rounded-lg shadow-lg shadow-blue-500/30">
                <i class="fa-solid fa-screwdriver-wrench"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg leading-tight tracking-tight">TechManager</h1>
                <p class="text-[10px] text-slate-500 uppercase font-bold tracking-wide">Integrated Asset System</p>
            </div>
        </div>
        
        <div class="flex gap-2 items-center">
            <div class="hidden md:flex bg-slate-100 rounded-lg p-1 border items-center mr-2">
                <span class="text-[9px] font-extrabold text-slate-400 px-2 uppercase tracking-wider">Export</span>
                <button onclick="app.downloadJSON()" class="w-8 h-8 flex items-center justify-center text-slate-600 hover:text-purple-600 hover:bg-white rounded transition" title="Backup JSON"><i class="fa-solid fa-database"></i></button>
                <button onclick="app.downloadExcel()" class="w-8 h-8 flex items-center justify-center text-slate-600 hover:text-green-600 hover:bg-white rounded transition" title="Download Excel"><i class="fa-solid fa-file-excel"></i></button>
                <button onclick="app.downloadWord()" class="w-8 h-8 flex items-center justify-center text-slate-600 hover:text-blue-600 hover:bg-white rounded transition" title="Download Word"><i class="fa-solid fa-file-word"></i></button>
                <button onclick="app.downloadPDF()" class="w-8 h-8 flex items-center justify-center text-slate-600 hover:text-red-600 hover:bg-white rounded transition" title="Download PDF A3"><i class="fa-solid fa-file-pdf"></i></button>
                <div class="w-px h-5 bg-slate-300 mx-1"></div>
                <button onclick="window.print()" class="w-8 h-8 flex items-center justify-center text-slate-600 hover:text-slate-900 hover:bg-white rounded transition" title="Print Native"><i class="fa-solid fa-print"></i></button>
            </div>
            <button onclick="app.syncData()" class="p-2 text-slate-500 hover:text-primary transition bg-slate-50 rounded-lg border border-transparent hover:border-slate-200" title="Sync GitHub"><i class="fa-solid fa-cloud-arrow-down"></i></button>
            <button onclick="ui.showSettings()" class="p-2 text-slate-500 hover:text-primary transition bg-slate-50 rounded-lg border border-transparent hover:border-slate-200" title="Settings"><i class="fa-solid fa-gear"></i></button>
        </div>
    </nav>
    <!-- TABS -->
    <div class="bg-white border-b px-4 flex gap-6 text-sm overflow-x-auto tab-nav no-print shadow-[0_4px_6px_-1px_rgba(0,0,0,0.02)]">
        <button onclick="ui.switchTab('assets')" id="tab-assets" class="border-b-2 border-primary text-primary font-bold py-3 px-1 transition focus:outline-none"><i class="fa-solid fa-list mr-1"></i> Data Aset</button>
        <button onclick="ui.switchTab('schedule')" id="tab-schedule" class="text-slate-500 py-3 px-1 transition hover:text-slate-700 focus:outline-none"><i class="fa-regular fa-calendar-check mr-1"></i> Jadwal Teknisi</button>
    </div>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto p-4 md:p-6 relative bg-slate-50/50">
        <!-- VIEW: ASSETS -->
        <div id="view-assets" class="block max-w-7xl mx-auto">
            <div class="flex flex-col md:flex-row gap-3 mb-6 justify-between no-print sticky top-0 bg-slate-50/95 backdrop-blur z-10 py-2">
                <div class="flex gap-2 w-full md:w-auto">
                    <div class="relative flex-1 md:w-72 shadow-sm">
                        <i class="fa-solid fa-search absolute left-3 top-3 text-slate-400 text-sm"></i>
                        <input type="text" id="searchAsset" onkeyup="app.renderAssets()" placeholder="Cari lokasi, merk, kondisi..." class="w-full pl-9 pr-3 py-2.5 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition">
                    </div>
                    <select id="filterType" onchange="app.renderAssets()" class="border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white shadow-sm focus:outline-none focus:border-primary">
                        <option value="all">Semua Aset</option>
                        <option value="AC">Hanya AC</option>
                        <option value="Light">Hanya Lampu</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <button onclick="ui.toggleMultiSelect()" id="btn-multiselect" class="px-4 py-2 border border-slate-200 bg-white rounded-lg text-sm font-medium hover:bg-slate-50 text-slate-600 shadow-sm transition"><i class="fa-solid fa-check-double mr-1.5"></i> Pilih</button>
                    <button onclick="ui.showAssetModal()" class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-bold hover:bg-blue-700 shadow-md shadow-blue-500/20 transition flex items-center"><i class="fa-solid fa-plus mr-1.5"></i> Aset Baru</button>
                </div>
            </div>
            <!-- Stats Dashboard -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 print:grid-cols-4">
                <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                    <div class="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-1">Total Unit</div>
                    <div class="text-2xl font-black text-slate-800" id="stat-total">0</div>
                </div>
                <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm border-l-4 border-l-green-500">
                    <div class="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-1">Kondisi Normal</div>
                    <div class="text-2xl font-black text-green-600" id="stat-normal">0</div>
                </div>
                <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm border-l-4 border-l-red-500">
                    <div class="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-1">Rusak / Kendala</div>
                    <div class="text-2xl font-black text-red-600" id="stat-issue">0</div>
                </div>
                <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm border-l-4 border-l-yellow-500">
                    <div class="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-1">Perlu Servis</div>
                    <div class="text-2xl font-black text-yellow-600" id="stat-maintenance">0</div>
                </div>
            </div>
            <!-- Asset Grid -->
            <div id="asset-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 pb-20"></div>
        </div>

        <!-- VIEW: SCHEDULE -->
        <div id="view-schedule" class="hidden max-w-3xl mx-auto">
            <div class="flex justify-between items-end mb-6 no-print">
                <div><h2 class="text-2xl font-black text-slate-800">Jadwal Harian</h2><p class="text-sm text-slate-500 font-medium" id="current-date">Today</p></div>
                <button onclick="ui.showTaskModal()" class="px-5 py-2.5 bg-slate-800 text-white rounded-lg text-sm font-bold shadow-lg hover:bg-slate-700 transition"><i class="fa-solid fa-plus mr-2"></i> Tambah Tugas</button>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden"><div id="schedule-list" class="divide-y divide-slate-50"></div></div>
            <div class="mt-4 text-center text-xs text-slate-400">Data jadwal disinkronisasi otomatis ke GitHub saat diubah.</div>
        </div>
    </main>
    <!-- FLOATING BULK ACTIONS -->
    <div id="bulk-actions" class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 shadow-[0_-10px_40px_-10px_rgba(0,0,0,0.1)] z-30 transform translate-y-full transition-transform duration-300 flex justify-between items-center no-print">
        <div class="font-bold text-slate-700 flex items-center gap-2"><span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs" id="selected-count">0</span><span class="text-sm">Item Dipilih</span></div>
        <div class="flex gap-2">
            <button onclick="app.bulkDelete()" class="px-4 py-2 bg-red-50 text-red-600 rounded-lg text-sm font-bold hover:bg-red-100 transition">Hapus</button>
            <div class="w-px bg-slate-200 mx-1"></div>
            <button onclick="app.bulkUpdateStatus('Perlu Servis')" class="px-3 py-2 text-yellow-600 hover:bg-yellow-50 rounded-lg text-xs font-bold transition">Mark Servis</button>
            <button onclick="app.bulkUpdateStatus('Normal')" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-bold hover:bg-green-700 transition">Set Normal</button>
        </div>
    </div>

    <!-- MODAL: ASSET FORM -->
    <div id="modal-asset" class="fixed inset-0 bg-slate-900/40 hidden z-50 items-center justify-center p-4 backdrop-blur-sm no-print transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg flex flex-col max-h-[90vh] scale-95 transition-transform duration-200" id="modal-asset-content">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 rounded-t-2xl">
                <div><h3 class="font-bold text-lg text-slate-800" id="asset-modal-title">Edit Aset</h3><p class="text-xs text-slate-400">Pastikan data akurat.</p></div>
                <button onclick="ui.closeModal('modal-asset')" class="w-8 h-8 rounded-full bg-slate-100 text-slate-400 hover:bg-red-50 hover:text-red-500 transition flex items-center justify-center"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto">
                <form id="assetForm" onsubmit="app.saveAsset(event)">
                    <input type="hidden" id="input-id">
                    <div class="mb-5">
                        <label class="block text-[10px] font-bold uppercase tracking-wider text-slate-400 mb-2">Kategori Aset</label>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="cursor-pointer relative"><input type="radio" name="category" value="AC" class="peer hidden" checked onchange="ui.toggleFormType()"><div class="peer-checked:bg-sky-50 peer-checked:text-sky-700 peer-checked:border-sky-500 peer-checked:shadow-sm border border-slate-200 p-3 rounded-xl text-center transition-all hover:bg-slate-50"><i class="fa-solid fa-wind text-xl mb-1 block"></i><span class="text-xs font-bold">Air Conditioner</span></div></label>
                            <label class="cursor-pointer relative"><input type="radio" name="category" value="Light" class="peer hidden" onchange="ui.toggleFormType()"><div class="peer-checked:bg-yellow-50 peer-checked:text-yellow-700 peer-checked:border-yellow-500 peer-checked:shadow-sm border border-slate-200 p-3 rounded-xl text-center transition-all hover:bg-slate-50"><i class="fa-regular fa-lightbulb text-xl mb-1 block"></i><span class="text-xs font-bold">Pencahayaan</span></div></label>
                        </div>
                    </div>
                    <div class="mb-4"><label class="block text-[10px] font-bold uppercase tracking-wider text-slate-400 mb-1">Lokasi</label><input type="text" id="input-location" required class="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:border-primary outline-none" placeholder="Contoh: Ruang Meeting Lt.1"></div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-[10px] font-bold uppercase tracking-wider text-slate-400 mb-1">Merk</label><input type="text" id="input-brand" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm outline-none" placeholder="Daikin / Philips"></div>
                        <div><label class="block text-[10px] font-bold uppercase tracking-wider text-slate-400 mb-1">Model / Tipe</label><input type="text" id="input-model" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm outline-none" placeholder="2PK / LED 10W"></div>
                    </div>
                    <div class="mb-5"><label class="block text-[10px] font-bold uppercase tracking-wider text-slate-400 mb-1">Jenis Unit</label><select id="input-subtype" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm bg-white outline-none"></select></div>
                    <div class="mb-5 p-4 bg-slate-50 rounded-xl border border-slate-200">
                        <label class="block text-[10px] font-bold uppercase tracking-wider text-slate-400 mb-2">Kondisi & Diagnosa</label>
                        <select id="input-condition" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm mb-3 outline-none" onchange="ui.toggleIssueField(this.value)"><option value="Normal">‚úÖ Berfungsi Normal</option><option value="Perlu Servis">‚ö†Ô∏è Perlu Maintenance Rutin</option><option value="Rusak">‚ùå Rusak / Mati Total</option></select>
                        <div id="field-issue" class="hidden animate-fade-in-down">
                            <textarea id="input-issue" class="w-full border border-red-300 bg-red-50/50 rounded-lg p-3 text-sm focus:border-red-500 outline-none" rows="3" placeholder="Deskripsikan kendala..."></textarea>
                            <button type="button" onclick="ai.analyze()" class="mt-2 w-full py-2 bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white text-xs font-bold rounded-lg hover:opacity-90 shadow-sm flex items-center justify-center gap-2"><i class="fa-solid fa-wand-magic-sparkles"></i> Analisa AI (Smart Diagnosis)</button>
                            <div id="ai-result" class="hidden mt-3 p-3 bg-white border border-violet-100 rounded-lg text-xs text-slate-600 shadow-sm"><strong class="text-violet-600 block mb-1"><i class="fa-solid fa-robot mr-1"></i> Saran Perbaikan:</strong><span id="ai-text"></span></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div><label class="block text-[10px] font-bold uppercase tracking-wider text-slate-400 mb-1">Tgl Pasang</label><input type="date" id="input-install" class="w-full border border-slate-300 rounded-lg p-2 text-sm text-slate-600"></div>
                        <div><label class="block text-[10px] font-bold uppercase tracking-wider text-slate-400 mb-1">Servis Terakhir</label><input type="date" id="input-service" class="w-full border border-slate-300 rounded-lg p-2 text-sm text-slate-600"></div>
                    </div>
                    <button type="submit" class="w-full bg-primary text-white py-3.5 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-500/30">Simpan Data</button>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: TASK & SETTINGS -->
    <div id="modal-task" class="fixed inset-0 bg-slate-900/40 hidden z-50 items-center justify-center p-4 backdrop-blur-sm no-print"><div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 scale-95"><h3 class="font-bold text-lg mb-4 text-slate-800">Tambah Tugas Harian</h3><form onsubmit="app.saveTask(event)"><input type="text" id="task-desc" required class="w-full border rounded-lg p-3 mb-3 text-sm focus:border-primary outline-none" placeholder="Deskripsi tugas"><div class="flex gap-2 mb-6"><input type="time" id="task-time" required class="border rounded-lg p-2 w-1/3 text-sm"><select id="task-prio" class="border rounded-lg p-2 flex-1 text-sm"><option value="Normal">Prioritas Normal</option><option value="High">Prioritas Tinggi üî•</option></select></div><div class="flex gap-2 justify-end"><button type="button" onclick="ui.closeModal('modal-task')" class="px-4 py-2 text-slate-500 text-sm font-medium hover:bg-slate-50 rounded-lg transition">Batal</button><button type="submit" class="px-6 py-2 bg-slate-800 text-white rounded-lg text-sm font-bold hover:bg-slate-700 transition">Tambah</button></div></form></div></div>
    <div id="modal-settings" class="fixed inset-0 bg-slate-900/80 hidden z-50 items-center justify-center p-4 no-print"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden"><div class="bg-slate-900 text-white p-5"><h3 class="font-bold text-lg"><i class="fa-brands fa-github mr-2"></i>Database Cloud</h3><p class="text-xs text-slate-400 mt-1">Hubungkan ke GitHub Repository.</p></div><div class="p-6 space-y-4"><div><label class="text-xs font-bold text-slate-500 uppercase">Username GitHub</label><input type="text" id="conf-owner" class="w-full border rounded-lg p-2.5 text-sm mt-1" placeholder="username"></div><div><label class="text-xs font-bold text-slate-500 uppercase">Nama Repository</label><input type="text" id="conf-repo" class="w-full border rounded-lg p-2.5 text-sm mt-1" placeholder="tech-manager"></div><div><label class="text-xs font-bold text-slate-500 uppercase">Personal Access Token</label><input type="password" id="conf-token" class="w-full border rounded-lg p-2.5 text-sm mt-1" placeholder="ghp_xxxxxxxxxxxx"></div><div><label class="text-xs font-bold text-slate-500 uppercase">File Path</label><input type="text" id="conf-path" class="w-full border rounded-lg p-2.5 text-sm mt-1 bg-slate-50" value="data/db_maintenance.json" readonly></div><button onclick="app.saveSettings()" class="w-full mt-2 bg-primary text-white py-3 rounded-xl font-bold hover:bg-blue-600 transition shadow-lg shadow-blue-500/20">Simpan & Koneksi</button><button onclick="ui.closeModal('modal-settings')" class="w-full py-2 text-slate-400 text-xs hover:text-slate-600">Tutup</button></div></div></div>
    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- 1. UTILITIES ---
        const ut = {
            id: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
            b64Enc: (str) => btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1))),
            b64Dec: (str) => decodeURIComponent(atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''))
        };

        // --- 2. STATE ---
        const state = {
            db: { assets: [], schedules: [] }, sha: null,
            config: { owner: localStorage.getItem('gh_owner') || '', repo: localStorage.getItem('gh_repo') || '', token: localStorage.getItem('gh_token') || '', path: 'data/db_maintenance.json' },
            ui: { currentTab: 'assets', multiSelectMode: false, selectedIds: new Set() }
        };

        // --- 3. AI EXPERT SYSTEM ---
        const ai = {
            analyze: () => {
                const issue = document.getElementById('input-issue').value.toLowerCase();
                const cat = document.querySelector('input[name="category"]:checked').value;
                let advice = "Belum ada diagnosa spesifik. Lakukan pengecekan manual standar.";
                if (cat === 'AC') {
                    if (issue.includes('bocor') || issue.includes('air') || issue.includes('netes')) advice = "Cek saluran pembuangan (drain pipe), tersumbat lendir. Vacuum drain atau semprot air tekanan rendah. Cek kemiringan instalasi.";
                    else if (issue.includes('panas') || issue.includes('tidak dingin')) advice = "Cek tekanan Freon, bocor halus di nepple. Cek kebersihan Evaporator & Kondensor. Ukur Ampere kompresor.";
                    else if (issue.includes('berisik') || issue.includes('bunyi')) advice = "Cek bearing motor fan indoor/outdoor. Cek baut body kendor. Pastikan tidak ada benda asing di blower wheel.";
                    else if (issue.includes('mati') || issue.includes('tidak hidup')) advice = "Cek tegangan listrik masuk (PLN). Periksa sekring/MCB. Cek Thermistor dan Modul PCB.";
                } else { // Lights
                    if (issue.includes('kedip')) advice = "Cek stabilitas tegangan. Jika LED, Driver/Power Supply lemah atau kapasitor kembung.";
                    else if (issue.includes('mati')) advice = "Cek bohlam dgn multitester. Cek fitting berkarat/longgar. Cek saklar dan kabel di plafon.";
                }
                document.getElementById('ai-text').innerText = advice;
                document.getElementById('ai-result').classList.remove('hidden');
            }
        };
        // --- 4. MAIN APP LOGIC ---
        const app = {
            init: () => {
                document.getElementById('current-date').innerText = dayjs().format('dddd, D MMMM YYYY');
                if (state.config.token && state.config.owner) app.syncData(); else ui.showSettings();
            },
            
            downloadJSON: () => {
                const blob = new Blob([JSON.stringify(state.db, null, 2)], { type: "application/json" });
                saveAs(blob, `Backup_TechManager_${dayjs().format('YYYY-MM-DD')}.json`);
            },
            downloadPDF: () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a3');
                doc.setFontSize(24); doc.setTextColor(40); doc.text("Laporan Inventaris & Maintenance", 15, 20);
                doc.setFontSize(10); doc.setTextColor(100); doc.text(`Generated on ${dayjs().format('DD MMMM YYYY')}`, 15, 26);
                const rows = state.db.assets.map((item, index) => [index + 1, item.location, item.category, item.brand + ' ' + item.model, item.subtype, item.condition, item.issue || '-', item.installDate || '-', item.serviceDate || '-']);
                doc.autoTable({
                    startY: 35, head: [['No', 'Lokasi', 'Kategori', 'Unit', 'Jenis', 'Kondisi', 'Detail Kendala', 'Tgl Pasang', 'Tgl Servis']], body: rows, theme: 'grid',
                    headStyles: { fillColor: [37, 99, 235] }, columnStyles: { 1: { cellWidth: 50 }, 6: { cellWidth: 80 } },
                    didParseCell: (data) => { if (data.column.index === 5 && data.cell.raw === 'Rusak') data.cell.styles.textColor = [220, 38, 38]; }
                });
                doc.save(`Laporan_Aset_${dayjs().format('YYYY-MM-DD')}.pdf`);
            },
            downloadExcel: () => {
                const data = state.db.assets.map((item, i) => ({ 'No': i+1, 'Lokasi': item.location, 'Kategori': item.category, 'Merk': item.brand, 'Model': item.model, 'Jenis': item.subtype, 'Kondisi': item.condition, 'Masalah': item.issue||'-', 'Tgl Pasang': item.installDate, 'Servis': item.serviceDate }));
                const ws = XLSX.utils.json_to_sheet(data); ws['!cols'] = [{wch:5}, {wch:30}, {wch:10}, {wch:15}, {wch:20}, {wch:15}, {wch:15}, {wch:40}, {wch:15}, {wch:15}];
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Data Aset");
                XLSX.writeFile(wb, `Data_Aset_${dayjs().format('YYYY-MM-DD')}.xlsx`);
            },
            downloadWord: () => {
                const { Document, Packer, Paragraph, Table, TableCell, TableRow, WidthType, TextRun, HeadingLevel, PageOrientation } = window.docx;
                const headerRow = new TableRow({ children: ['No', 'Lokasi', 'Kategori', 'Unit', 'Kondisi', 'Kendala', 'Servis'].map(t => new TableCell({ children: [new Paragraph({ text: t, style: "strong" })], shading: { fill: "EFEFEF" }, width: { size: 100/7, type: WidthType.PERCENTAGE } })) });
                const rows = state.db.assets.map((item, idx) => new TableRow({ children: [(idx + 1).toString(), item.location, item.category, `${item.brand} ${item.model}`, item.condition, item.issue || '-', item.serviceDate || '-'].map((txt, i) => new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: txt, bold: (i===4 && txt==='Rusak'), color: (i===4 && txt==='Rusak') ? "FF0000" : "000000" })] })], width: { size: 100/7, type: WidthType.PERCENTAGE } })) }));
                const doc = new Document({ sections: [{ properties: { page: { size: { orientation: PageOrientation.LANDSCAPE } } }, children: [new Paragraph({ text: "Laporan Aset", heading: HeadingLevel.HEADING_1 }), new Table({ rows: [headerRow, ...rows], width: { size: 100, type: WidthType.PERCENTAGE } })] }] });
                Packer.toBlob(doc).then(blob => saveAs(blob, `Laporan_${dayjs().format('YYYY-MM-DD')}.docx`));
            },
            // --- GITHUB SYNC ---
            saveSettings: () => {
                state.config.owner = document.getElementById('conf-owner').value; state.config.repo = document.getElementById('conf-repo').value; state.config.token = document.getElementById('conf-token').value;
                localStorage.setItem('gh_owner', state.config.owner); localStorage.setItem('gh_repo', state.config.repo); localStorage.setItem('gh_token', state.config.token);
                ui.closeModal('modal-settings'); app.syncData();
            },
            syncData: async () => {
                const { owner, repo, path, token } = state.config;
                if (!token) return;
                Swal.fire({ title: 'Sinkronisasi...', didOpen: () => Swal.showLoading() });
                try {
                    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, { headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' } });
                    if (res.status === 404) { state.db = { assets: [], schedules: [] }; state.sha = null; await app.pushToGitHub("Init DB"); }
                    else if (res.ok) {
                        const json = await res.json(); state.sha = json.sha;
                        state.db = JSON.parse(ut.b64Dec(json.content));
                        if (!state.db.assets) state.db.assets = []; if (!state.db.schedules) state.db.schedules = [];
                    } else throw new Error(res.status);
                    app.renderAssets(); app.renderSchedule(); Swal.close();
                    Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 }).fire({ icon: 'success', title: 'Data Sinkron' });
                } catch (err) { Swal.fire('Error', 'Cek Token/Repo: ' + err.message, 'error'); }
            },
            pushToGitHub: async (message) => {
                const { owner, repo, path, token } = state.config;
                try {
                    const body = { message: message, content: ut.b64Enc(JSON.stringify(state.db, null, 2)) };
                    if (state.sha) body.sha = state.sha;
                    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, { method: 'PUT', headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                    if (res.ok) { const json = await res.json(); state.sha = json.content.sha; }
                } catch (e) { Swal.fire('Error', 'Gagal simpan cloud', 'error'); }
            },
            // --- CRUD ---
            saveAsset: async (e) => {
                e.preventDefault();
                const id = document.getElementById('input-id').value;
                const asset = {
                    id: id || ut.id(), category: document.querySelector('input[name="category"]:checked').value,
                    location: document.getElementById('input-location').value, brand: document.getElementById('input-brand').value,
                    model: document.getElementById('input-model').value, subtype: document.getElementById('input-subtype').value,
                    condition: document.getElementById('input-condition').value, issue: document.getElementById('input-issue').value,
                    installDate: document.getElementById('input-install').value, serviceDate: document.getElementById('input-service').value, updatedAt: new Date().toISOString()
                };
                if (id) { state.db.assets[state.db.assets.findIndex(x => x.id === id)] = asset; } else { state.db.assets.push(asset); }
                ui.closeModal('modal-asset'); app.renderAssets(); app.pushToGitHub(`Update Aset: ${asset.location}`);
            },
            saveTask: async (e) => {
                e.preventDefault();
                state.db.schedules.push({ id: ut.id(), desc: document.getElementById('task-desc').value, time: document.getElementById('task-time').value, prio: document.getElementById('task-prio').value, completed: false, date: dayjs().format('YYYY-MM-DD') });
                ui.closeModal('modal-task'); app.renderSchedule(); app.pushToGitHub('Tambah Tugas');
            },
            toggleTask: (id) => { const t = state.db.schedules.find(t => t.id === id); if(t) { t.completed = !t.completed; app.renderSchedule(); app.pushToGitHub('Update Status'); } },
            deleteTask: (id) => { state.db.schedules = state.db.schedules.filter(t => t.id !== id); app.renderSchedule(); app.pushToGitHub('Hapus Tugas'); },
            
            // --- BULK ---
            toggleSelect: (id) => { if (state.ui.selectedIds.has(id)) state.ui.selectedIds.delete(id); else state.ui.selectedIds.add(id); app.renderAssets(); ui.updateBulkBar(); },
            bulkDelete: async () => { if (!confirm(`Hapus ${state.ui.selectedIds.size} item?`)) return; state.db.assets = state.db.assets.filter(a => !state.ui.selectedIds.has(a.id)); ui.toggleMultiSelect(); app.renderAssets(); app.pushToGitHub('Bulk Delete'); },
            bulkUpdateStatus: async (status) => { state.db.assets.forEach(a => { if (state.ui.selectedIds.has(a.id)) { a.condition = status; if (status === 'Normal') a.issue = ''; } }); ui.toggleMultiSelect(); app.renderAssets(); app.pushToGitHub('Bulk Update'); },
            // --- RENDER ---
            renderAssets: () => {
                const list = document.getElementById('asset-list');
                const term = document.getElementById('searchAsset').value.toLowerCase(); const type = document.getElementById('filterType').value;
                const filtered = state.db.assets.filter(a => (type === 'all' || a.category === type) && (a.location.toLowerCase().includes(term) || a.brand.toLowerCase().includes(term) || (a.issue && a.issue.toLowerCase().includes(term))));
                
                document.getElementById('stat-total').innerText = state.db.assets.length;
                document.getElementById('stat-normal').innerText = state.db.assets.filter(a => a.condition === 'Normal').length;
                document.getElementById('stat-issue').innerText = state.db.assets.filter(a => a.condition === 'Rusak').length;
                document.getElementById('stat-maintenance').innerText = state.db.assets.filter(a => a.condition === 'Perlu Servis').length;

                list.innerHTML = filtered.map(a => {
                    const isSel = state.ui.selectedIds.has(a.id); const icon = a.category === 'AC' ? 'fa-wind text-sky-500' : 'fa-lightbulb text-yellow-500';
                    const color = a.condition === 'Normal' ? 'bg-green-100 text-green-700' : a.condition === 'Rusak' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700';
                    const chk = state.ui.multiSelectMode ? `<div class="absolute top-3 left-3 z-10" onclick="event.stopPropagation()"><input type="checkbox" ${isSel ? 'checked' : ''} class="w-5 h-5" onchange="app.toggleSelect('${a.id}')"></div>` : '';
                    return `<div class="asset-card bg-white p-5 rounded-2xl shadow-sm border border-slate-100 relative group hover:shadow-md ${isSel ? 'selected' : ''}" onclick="${state.ui.multiSelectMode ? `app.toggleSelect('${a.id}')` : ''}">${chk}<div class="flex justify-between items-start mb-3 ${state.ui.multiSelectMode ? 'pl-8' : ''}"><div><h4 class="font-bold text-slate-800">${a.location}</h4><div class="text-xs text-slate-500 mt-1"><i class="fa-solid ${icon}"></i> ${a.brand} ${a.model}</div></div><span class="text-[10px] font-bold px-2 py-1 rounded-full ${color}">${a.condition}</span></div>${a.issue ? `<div class="bg-red-50 text-red-600 text-xs p-2.5 rounded-lg mb-3 border border-red-100"><i class="fa-solid fa-triangle-exclamation"></i> ${a.issue}</div>` : '<div class="h-4 mb-3"></div>'}<div class="flex justify-between items-center pt-3 border-t text-xs text-slate-400"><div>Servis: ${a.serviceDate || '-'}</div>${!state.ui.multiSelectMode ? `<button onclick="ui.editAsset('${a.id}')" class="text-primary font-bold hover:underline">Detail/Edit</button>` : ''}</div></div>`;
                }).join('');
            },
            renderSchedule: () => {
                const list = document.getElementById('schedule-list'); const sorted = state.db.schedules.sort((a,b) => a.time.localeCompare(b.time));
                list.innerHTML = sorted.length ? sorted.map(t => `<div class="p-4 flex items-center justify-between hover:bg-slate-50 transition group"><div class="flex items-center gap-4"><button onclick="app.toggleTask('${t.id}')" class="text-2xl ${t.completed ? 'text-green-500' : 'text-slate-300'}"><i class="fa-regular ${t.completed ? 'fa-circle-check' : 'fa-circle'}"></i></button><div class="${t.completed ? 'opacity-40 line-through' : ''}"><div class="font-bold text-slate-700">${t.desc}</div><div class="text-xs text-slate-500">${t.time} ${t.prio === 'High' ? '<span class="text-red-500 font-bold ml-2">PRIORITY</span>' : ''}</div></div></div><button onclick="app.deleteTask('${t.id}')" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 px-2"><i class="fa-solid fa-trash"></i></button></div>`).join('') : '<div class="p-10 text-center text-slate-400">Belum ada tugas.</div>';
            }
        };

        // --- 5. UI HANDLERS ---
        const ui = {
            switchTab: (tab) => {
                document.querySelectorAll('main > div').forEach(el => el.classList.add('hidden')); document.getElementById(`view-${tab}`).classList.remove('hidden');
                document.getElementById('tab-assets').className = tab === 'assets' ? 'border-b-2 border-primary text-primary font-bold py-3 px-1 transition' : 'text-slate-500 py-3 px-1 transition';
                document.getElementById('tab-schedule').className = tab === 'schedule' ? 'border-b-2 border-primary text-primary font-bold py-3 px-1 transition' : 'text-slate-500 py-3 px-1 transition';
            },
            showAssetModal: () => { document.getElementById('assetForm').reset(); document.getElementById('input-id').value = ''; document.getElementById('asset-modal-title').innerText = 'Tambah Aset'; ui.toggleFormType(); ui.toggleIssueField('Normal'); document.getElementById('modal-asset').classList.remove('hidden'); },
            editAsset: (id) => {
                const a = state.db.assets.find(x => x.id === id); if (!a) return;
                document.getElementById('input-id').value = a.id; document.querySelector(`input[name="category"][value="${a.category}"]`).checked = true;
                document.getElementById('input-location').value = a.location; document.getElementById('input-brand').value = a.brand; document.getElementById('input-model').value = a.model;
                document.getElementById('input-install').value = a.installDate; document.getElementById('input-service').value = a.serviceDate;
                document.getElementById('input-condition').value = a.condition; document.getElementById('input-issue').value = a.issue || '';
                ui.toggleFormType(a.subtype); ui.toggleIssueField(a.condition); document.getElementById('asset-modal-title').innerText = 'Edit Aset'; document.getElementById('modal-asset').classList.remove('hidden');
            },
            toggleFormType: (sel = null) => {
                const cat = document.querySelector('input[name="category"]:checked').value; const select = document.getElementById('input-subtype'); select.innerHTML = '';
                const opts = cat === 'AC' ? ['Split Wall', 'Cassette', 'Standing', 'Central', 'Portable'] : ['LED Bulb', 'TL / Neon', 'Downlight', 'Spotlight', 'Lampu Jalan'];
                opts.forEach(o => { const opt = document.createElement('option'); opt.value = o; opt.text = o; if (sel === o) opt.selected = true; select.appendChild(opt); });
            },
            toggleIssueField: (val) => document.getElementById('field-issue').classList.toggle('hidden', val === 'Normal'),
            showTaskModal: () => document.getElementById('modal-task').classList.remove('hidden'),
            closeModal: (id) => document.getElementById(id).classList.add('hidden'),
            showSettings: () => {
                document.getElementById('conf-owner').value = state.config.owner; document.getElementById('conf-repo').value = state.config.repo; document.getElementById('conf-token').value = state.config.token;
                document.getElementById('modal-settings').classList.remove('hidden');
            },
            toggleMultiSelect: () => {
                state.ui.multiSelectMode = !state.ui.multiSelectMode; state.ui.selectedIds.clear();
                const btn = document.getElementById('btn-multiselect'); const bar = document.getElementById('bulk-actions');
                btn.classList.toggle('bg-slate-100', state.ui.multiSelectMode); btn.classList.toggle('text-primary', state.ui.multiSelectMode);
                bar.classList.toggle('translate-y-full', !state.ui.multiSelectMode); app.renderAssets();
            },
            updateBulkBar: () => document.getElementById('selected-count').innerText = state.ui.selectedIds.size
        };

        document.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>
